import requests
from bs4 import BeautifulSoup
import json, sqlite3, os, time, re, random, warnings
from urllib.parse import urljoin, urlparse
warnings.filterwarnings('ignore')

DATA_DIR = './travel_survey_final'
os.makedirs(DATA_DIR, exist_ok=True)

class FinalSurveyCrawler:
    """æœ€ç»ˆç‰ˆçˆ¬è™«"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.9,en-US,en;q=0.8',
        })
        self.all_questions = []
        self.seen_questions = set()
        self.seen_urls = set()
        self.stats = {
            'direct_success': 0,
            'need_sublinks': 0,
            'sublinks_success': 0,
            'total_failed': 0,
            'total_questions': 0
        }
        self.init_database()
    
    def init_database(self):
        conn = sqlite3.connect(f'{DATA_DIR}/questions.db')
        c = conn.cursor()
        c.execute("""
            CREATE TABLE IF NOT EXISTS questions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                question_text TEXT UNIQUE,
                options_text TEXT,
                question_type TEXT,
                category TEXT,
                language TEXT,
                source_url TEXT,
                source_name TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        conn.commit()
        conn.close()
    
    def safe_get(self, url, timeout=15):
        """å®‰å…¨è¯·æ±‚"""
        try:
            response = self.session.get(url, timeout=timeout, verify=False, allow_redirects=True)
            if response.status_code == 200:
                return response.text
        except:
            pass
        return None
    
    def is_travel_question(self, text):
        """åˆ¤æ–­æ˜¯å¦æ˜¯æ—…æ¸¸é—®é¢˜"""
        if not text or len(text) < 8 or len(text) > 500:
            return False
        
        # é—®å¥ç‰¹å¾
        question_markers = ['?', 'ï¼Ÿ', 'how', 'what', 'which', 'would', 'do you', 'æ‚¨', 'è¯·', 'æ˜¯å¦', 'å¦‚ä½•']
        if not any(m in text.lower() for m in question_markers):
            return False
        
        # æ—…æ¸¸å…³é”®è¯
        travel_keywords = [
            'æ—…æ¸¸', 'æ—…è¡Œ', 'å‡ºè¡Œ', 'é…’åº—', 'ä½å®¿', 'æ™¯åŒº', 'æ™¯ç‚¹', 'å¯¼æ¸¸', 'æ»¡æ„',
            'æœåŠ¡', 'äº¤é€š', 'æ¸¸å®¢', 'å®šåˆ¶', 'è¡Œç¨‹', 'é¢„è®¢', 'ä½“éªŒ', 'è¯„ä»·', 'æˆ¿é—´',
            'hotel', 'room', 'travel', 'trip', 'tour', 'vacation', 'guest',
            'service', 'stay', 'accommodation', 'satisfied', 'experience',
            'destination', 'restaurant', 'food', 'location', 'flight'
        ]
        
        return any(k in text.lower() for k in travel_keywords)
    
    def extract_options(self, options_list):
        """ä»é€‰é¡¹åˆ—è¡¨æå–æ–‡æœ¬"""
        if not options_list:
            return None
        
        cleaned = []
        for opt in options_list[:10]:
            opt = opt.strip()
            if opt and len(opt) < 100:
                opt = re.sub(r'^[A-Z0-9â‘ -â‘©][\.)ã€ï¼]\s*', '', opt)
                if opt and opt not in ['è¯·é€‰æ‹©', 'Please Select', 'å…¶ä»–']:
                    cleaned.append(opt)
        
        if len(cleaned) >= 2:
            return ' / '.join(cleaned)
        return None
    
    def determine_question_type(self, options_text, question_text=''):
        """åˆ¤æ–­é—®é¢˜ç±»å‹"""
        if not options_text:
            return 'open_ended'
        
        opts_lower = options_text.lower()
        
        if any(w in opts_lower for w in ['1-5', '1-10', '0-10', 'scale', 'rating', 'åˆ†']):
            return 'rating'
        
        if re.search(r'\b(yes|no|æ˜¯|å¦)\b', opts_lower):
            return 'yes_no'
        
        if 'å¤šé€‰' in question_text or 'multiple' in question_text.lower():
            return 'multiple_choice'
        
        return 'single_choice'
    
    def categorize_question(self, text):
        """é—®é¢˜åˆ†ç±»"""
        t = text.lower()
        
        if any(w in t for w in ['æ»¡æ„', 'satisfied', 'satisfaction']):
            return 'satisfaction'
        elif any(w in t for w in ['æˆ¿é—´', 'room', 'ä½å®¿', 'accommodation']):
            return 'room'
        elif any(w in t for w in ['æœåŠ¡', 'service', 'å‘˜å·¥', 'staff']):
            return 'service'
        elif any(w in t for w in ['é¤', 'food', 'meal', 'breakfast', 'dining']):
            return 'food'
        elif any(w in t for w in ['ä½ç½®', 'location', 'äº¤é€š', 'transportation']):
            return 'location'
        elif any(w in t for w in ['ä»·æ ¼', 'price', 'è´¹ç”¨', 'cost']):
            return 'price'
        elif any(w in t for w in ['æ¨è', 'recommend']):
            return 'recommendation'
        elif any(w in t for w in ['æ™¯ç‚¹', 'attraction', 'æ™¯åŒº']):
            return 'attraction'
        elif any(w in t for w in ['å¯¼æ¸¸', 'guide', 'è¡Œç¨‹', 'itinerary']):
            return 'tour'
        else:
            return 'general'
    
    # ==================== ç½‘ç«™ç‰¹å®šè§£æå™¨ ====================
    
    def parse_wjx(self, html, url):
        """é—®å·æ˜Ÿè§£æå™¨"""
        soup = BeautifulSoup(html, 'html.parser')
        questions = []
        
        for field in soup.find_all('div', class_='field'):
            q_tag = field.find('div', class_='field-label')
            if not q_tag:
                continue
            
            q_text = q_tag.get_text(strip=True)
            q_text = re.sub(r'^\d+[\.)ã€]\s*', '', q_text)
            
            if not self.is_travel_question(q_text):
                continue
            
            options = []
            for opt in field.find_all('div', class_=['ui-radio', 'ui-checkbox']):
                opt_text = opt.get_text(strip=True)
                if opt_text:
                    options.append(opt_text)
            
            select = field.find('select')
            if select:
                for option in select.find_all('option'):
                    opt_text = option.get_text(strip=True)
                    if opt_text and opt_text != 'è¯·é€‰æ‹©':
                        options.append(opt_text)
            
            opts_text = self.extract_options(options)
            
            if q_text not in self.seen_questions:
                self.seen_questions.add(q_text)
                questions.append({
                    'question_text': q_text,
                    'options_text': opts_text or '',
                    'question_type': self.determine_question_type(opts_text, q_text),
                    'category': self.categorize_question(q_text),
                    'language': 'zh' if re.search(r'[\u4e00-\u9fff]', q_text) else 'en',
                    'source_url': url,
                    'source_name': 'é—®å·æ˜Ÿ'
                })
        
        return questions
    
    def parse_wenjuan(self, html, url):
        """é—®å·ç½‘è§£æå™¨"""
        soup = BeautifulSoup(html, 'html.parser')
        questions = []
        
        for q_div in soup.find_all('div', class_='question'):
            q_title = q_div.find('div', class_='question-title')
            if not q_title:
                continue
            
            q_text = q_title.get_text(strip=True)
            q_text = re.sub(r'^\d+[\.)ã€]\s*', '', q_text)
            
            if not self.is_travel_question(q_text):
                continue
            
            options = []
            for opt in q_div.find_all('label'):
                opt_text = opt.get_text(strip=True)
                if opt_text:
                    options.append(opt_text)
            
            opts_text = self.extract_options(options)
            
            if q_text not in self.seen_questions:
                self.seen_questions.add(q_text)
                questions.append({
                    'question_text': q_text,
                    'options_text': opts_text or '',
                    'question_type': self.determine_question_type(opts_text, q_text),
                    'category': self.categorize_question(q_text),
                    'language': 'zh',
                    'source_url': url,
                    'source_name': 'é—®å·ç½‘'
                })
        
        return questions
    
    def parse_jotform(self, html, url):
        """Jotformè§£æå™¨"""
        soup = BeautifulSoup(html, 'html.parser')
        questions = []
        
        for line in soup.find_all('li', class_='form-line'):
            label = line.find('label', class_='form-label')
            if not label:
                continue
            
            q_text = label.get_text(strip=True)
            
            if not self.is_travel_question(q_text):
                continue
            
            options = []
            for opt in line.find_all('label', class_=['form-radio-item-label', 'form-checkbox-item-label']):
                options.append(opt.get_text(strip=True))
            
            select = line.find('select')
            if select:
                for option in select.find_all('option'):
                    opt_text = option.get_text(strip=True)
                    if opt_text not in ['Please Select', 'è¯·é€‰æ‹©', '']:
                        options.append(opt_text)
            
            opts_text = self.extract_options(options)
            
            if q_text not in self.seen_questions:
                self.seen_questions.add(q_text)
                questions.append({
                    'question_text': q_text,
                    'options_text': opts_text or '',
                    'question_type': self.determine_question_type(opts_text, q_text),
                    'category': self.categorize_question(q_text),
                    'language': 'zh' if re.search(r'[\u4e00-\u9fff]', q_text) else 'en',
                    'source_url': url,
                    'source_name': 'Jotform'
                })
        
        return questions
    
    def parse_generic(self, html, url, source_name):
        soup = BeautifulSoup(html, 'html.parser')
        questions = []
        
        for tag in soup(['nav', 'header', 'footer', 'script', 'style']):
            tag.decompose()
        
        for tag in soup.find_all(['div', 'p', 'li', 'h3', 'h4', 'label']):
            text = tag.get_text(strip=True)
            
            if not text or len(text) < 8:
                continue
            
            if not self.is_travel_question(text):
                continue
            
            options = []
            
            next_sibling = tag.find_next_sibling()
            if next_sibling and next_sibling.name in ['ul', 'ol']:
                for li in next_sibling.find_all('li', limit=10):
                    opt = li.get_text(strip=True)
                    if opt and len(opt) < 100:
                        options.append(opt)
            
            parent = tag.parent
            if parent:
                for label in parent.find_all('label', limit=10):
                    opt = label.get_text(strip=True)
                    if opt != text and opt and len(opt) < 100:
                        options.append(opt)
            
            bracket_match = re.search(r'[\(ï¼ˆ]([^\)ï¼‰]{10,120})[\)ï¼‰]', text)
            if bracket_match:
                content = bracket_match.group(1)
                if '/' in content or 'ã€' in content:
                    options = re.split(r'[/ã€]', content)
                    text = text.replace(bracket_match.group(0), '').strip()
            
            opts_text = self.extract_options(options)
            
            if text not in self.seen_questions:
                self.seen_questions.add(text)
                questions.append({
                    'question_text': text,
                    'options_text': opts_text or '',
                    'question_type': self.determine_question_type(opts_text, text),
                    'category': self.categorize_question(text),
                    'language': 'zh' if re.search(r'[\u4e00-\u9fff]', text) else 'en',
                    'source_url': url,
                    'source_name': source_name
                })
        
        return questions
    
    def parse_survey_page(self, html, url, source_name):
        """æ ¹æ®URLé€‰æ‹©è§£æå™¨"""
        if 'wjx.cn' in url:
            return self.parse_wjx(html, url)
        elif 'wenjuan.com' in url or 'surveyyes.com' in url:
            return self.parse_wenjuan(html, url)
        elif 'jotform.com' in url:
            return self.parse_jotform(html, url)
        else:
            return self.parse_generic(html, url, source_name)
    
    def extract_sublinks(self, html, base_url):
        """æå–å­é“¾æ¥"""
        if not html:
            return []
        
        soup = BeautifulSoup(html, 'html.parser')
        links = []
        
        for a in soup.find_all('a', href=True):
            href = a['href']
            full_url = urljoin(base_url, href)
            
            if full_url in self.seen_urls:
                continue
            
            valid_patterns = [
                r'wjx\.cn/.*[vm]m?/',
                r'wenjuan\.com/.*detail',
                r'jinshuju\.net/f/',
                r'jotform\.com/form',
                r'surveymars\.com/.*survey',
                r'surveymonkey\.com/r/',
                r'forms\.app/.*forms/',
            ]
            
            if any(re.search(pattern, full_url) for pattern in valid_patterns):
                if full_url not in self.seen_urls:
                    self.seen_urls.add(full_url)
                    links.append(full_url)
        
        return links[:30]  # æ¯é¡µæœ€å¤š30ä¸ªå­é“¾æ¥
    
    def crawl_with_fallback(self, url, source_name):
        """ä¼˜å…ˆè§£æå½“å‰é¡µï¼Œæ— ç»“æœå†æå–å­é“¾æ¥"""
        print(f"å¤„ç†: {source_name[:60]:<60}", end=' ')
        
        html = self.safe_get(url)
        if not html:
            print("âœ— è®¿é—®å¤±è´¥")
            self.stats['total_failed'] += 1
            return []
        
        # 1. ä¼˜å…ˆï¼šå°è¯•ç›´æ¥è§£æå½“å‰é¡µ
        questions = self.parse_survey_page(html, url, source_name)
        
        if questions:
            # å½“å‰é¡µæœ‰é—®é¢˜ï¼Œç›´æ¥è¿”å›
            self.stats['direct_success'] += 1
            self.stats['total_questions'] += len(questions)
            print(f"âœ“ ç›´æ¥è§£æ {len(questions)}é¢˜")
            return questions
        
        # 2. å¤‡é€‰ï¼šå½“å‰é¡µæ— é—®é¢˜ï¼Œæå–å­é“¾æ¥
        self.stats['need_sublinks'] += 1
        sublinks = self.extract_sublinks(html, url)
        
        if not sublinks:
            print("âœ— æ— é¢˜ç›®ä¹Ÿæ— å­é“¾æ¥")
            return []
        
        print(f"â†’ æå–{len(sublinks)}ä¸ªå­é“¾æ¥")
        
        # 3. è§£æå­é“¾æ¥
        all_questions = []
        for i, sublink in enumerate(sublinks, 1):
            if i % 10 == 0:
                print(f"      å­é“¾æ¥è¿›åº¦: {i}/{len(sublinks)}")
            
            sub_html = self.safe_get(sublink)
            if sub_html:
                sub_questions = self.parse_survey_page(sub_html, sublink, source_name)
                if sub_questions:
                    all_questions.extend(sub_questions)
                    self.stats['sublinks_success'] += 1
            
            time.sleep(0.2)
        
        if all_questions:
            self.stats['total_questions'] += len(all_questions)
            print(f"      âœ“ å­é“¾æ¥å…±å¾— {len(all_questions)}é¢˜")
        
        return all_questions
    
    def get_all_urls(self):
        """è·å–æ–‡æ¡£ä¸­çš„æ‰€æœ‰URL"""
        urls = []
        
        # ============ è‹±æ–‡URL ============
        
        # ä¸€ã€ç»¼åˆæ—…æ¸¸/å‡ºè¡Œè¡Œä¸º & åå¥½ç±»é—®å·ï¼ˆ12ä¸ªï¼‰
        english_travel_general = [
            ('https://www.surveymonkey.com/learn/survey-best-practices/travel-survey/', 'SurveyMonkey-Travelå®è·µ'),
            ('https://www.surveymonkey.com/templates/vacation-travel-survey-template/', 'SurveyMonkey-å‡æœŸæ¨¡æ¿'),
            ('https://www.questionpro.com/survey-templates/travel-survey/', 'QuestionPro-Travel'),
            ('https://www.questionpro.com/survey-templates/travel-surveys/', 'QuestionPro-Travelç´¢å¼•'),
            ('https://surveysparrow.com/blog/travel-surveys/', 'SurveySparrow-Blog'),
            ('https://www.smartsurvey.com/sample-questions/travel-survey-questions', 'SmartSurvey-42é—®'),
            ('https://www.smartsurvey.com/templates/surveys/hospitality/travel-survey-template', 'SmartSurvey-æ¨¡æ¿'),
            ('https://www.startquestion.com/survey-ideas/travel-survey-questionnaire', 'Startquestion-Travel'),
            ('https://www.startquestion.com/survey-ideas/tourism-survey-questionnaire/', 'Startquestion-Tourism'),
            ('https://www.supersurvey.com/LPB-tourism', 'Supersurvey-Tourism'),
            ('https://surveyvista.com/resources/templates/travel-interest-survey/', 'SurveyVista-Interest'),
            ('https://surveymars.com/zh-Hans/templates/travel-interest-survey-template/', 'SurveyMars-ä¸­æ–‡å…´è¶£'),
        ]
        
        # äºŒã€é…’åº—/ä½å®¿æ»¡æ„åº¦ï¼ˆ13ä¸ªï¼‰
        english_hotel = [
            ('https://www.cloudbeds.com/templates/guest-surveys/', 'Cloudbeds-Guest'),
            ('https://www.cognitoforms.com/templates/404/hotel-guest-satisfaction-survey', 'Cognito-Hotel'),
            ('https://www.amadeus-hospitality.com/resources/guest-survey-template/', 'Amadeus-Template'),
            ('https://www.zonkafeedback.com/blog/hotel-customer-satisfaction-survey-questions', 'Zonka-Hotel'),
            ('https://www.helloshift.com/news/hotel-guest-satisfaction-survey-50-helpful-questions-survey-template', 'HelloShift-50é¢˜'),
            ('https://www.customer-alliance.com/en/articles/guest-satisfaction-survey/', 'CustomerAlliance'),
            ('https://www.jotform.com/form-templates/hotel-feedback-form', 'Jotform-Hotel'),
            ('https://www.forms.app/zh/templates/hotel-guest-survey', 'FormsApp-Hotel'),
            ('https://www.123formbuilder.com/free-form-templates/gallery-feedback-templates/travel-forms/', '123Form-Travel'),
            ('https://www.sampleforms.com/hotel-feedback-form.html', 'SampleForms-Hotel'),
            ('https://www.formcreatorai.com/form-hotel-feedback', 'FormCreator-Hotel'),
            ('https://www.limesurvey.org/template/hotel-guest-feedback-form-template', 'LimeSurvey-Hotel'),
        ]
        
        # ä¸‰ã€æ™¯ç‚¹/å¯¼æ¸¸/æ—…æ¸¸æœåŠ¡åé¦ˆï¼ˆ15ä¸ªï¼‰
        english_tour = [
            ('https://www.jotform.com/form-templates/tour-feedback-form', 'Jotform-Tour'),
            ('https://forms.app/en/templates/tour-feedback-form', 'FormsApp-Tour'),
            ('https://www.123formbuilder.com/free-form-templates/sightseeing-tour-feedback-form', '123Form-Sightseeing'),
            ('https://www.mailmodo.com/forms/tour-feedback-form/', 'Mailmodo-Tour'),
            ('https://www.poll-maker.com/tour-guide-feedback', 'PollMaker-Guide'),
            ('https://templatelibrary.com/online/google-forms-tour-feedback-form-template/', 'TemplateLib-Google'),
            ('https://academy.wetravel.com/travel-feedback-form-templates', 'WeTravel-Templates'),
            ('https://woorise.com/templates/category/travel-feedback-forms', 'Woorise-Travel'),
            ('https://forms.app/en/templates/tour-booking-form', 'FormsApp-Booking'),
            ('https://www.supersurvey.com/Vacation-Survey', 'Supersurvey-Vacation'),
            ('https://www.supersurvey.com/LPA-airline-customer-satisfaction', 'Supersurvey-Airline'),
            ('https://surveysparrow.com/templates/business/airline-passenger-feedback-survey-template/', 'SurveySparrow-Airline'),
            ('https://www.questionpro.com/survey-templates/airline-passenger-satisfaction-and-feedback-survey/', 'QuestionPro-Airline'),
            ('https://www.startquestion.com/survey-ideas/tourism-survey-questionnaire/', 'Startquestion-Tourism2'),
        ]
        
        # å››ã€æ—…æ¸¸åå¥½/å‡ºè¡Œæ–¹å¼é€‰æ‹©ï¼ˆ20ä¸ªï¼‰
        english_preference = [
            ('https://www.jotform.com/form-templates/traveling-preferences-survey', 'Jotform-Preferences'),
            ('https://www.jotform.com/form-templates/traveler-preferences-form', 'Jotform-Traveler'),
            ('https://www.jotform.com/form-templates/travel-interest-survey', 'Jotform-Interest'),
            ('https://www.jotform.com/form-templates/travel-questionnaire-form', 'Jotform-Questionnaire'),
            ('https://www.jotform.com/form-templates/travel-planning-questionnaire', 'Jotform-Planning'),
            ('https://form.jotform.com/232783784965172', 'Jotform-Planningç¤ºä¾‹1'),
            ('https://form.jotform.com/250577606058159', 'Jotform-Planningç¤ºä¾‹2'),
            ('https://www.jotform.com/form-templates/travel-form', 'Jotform-TravelForm'),
            ('https://www.jotform.com/form-templates/travel-inquiry-form', 'Jotform-Inquiry'),
            ('https://travelwelladventures.com/travel-questionnaire', 'TravelWell-Curated'),
            ('https://www.movetotraveling.com/trip-inquiry-form-for-travel-planning/', 'MoveToTravel-Inquiry'),
            ('https://globeandglamourtravel.com/b/travel-planning-questionnaire', 'GlobeGlamour'),
            ('https://zapier.com/templates/details/travel-questionnaire-form', 'Zapier-Template'),
            ('https://www.formassembly.com/form-templates/travel-preferences-survey/', 'FormAssembly-Preferences'),
            ('https://weba.cloud/tips/travel-preference-survey/', 'WEBA-åå¥½'),
            ('https://hostagencyreviews.com/blog/free-travel-agent-forms-clients', 'HostAgency-Forms'),
            ('https://www.template.net/edit-online/439629/travel-agency-client-intake-form', 'TemplateNet-Intake'),
            ('https://menageclaws.com/travel-agent-client-questionnaire-pdf/', 'MenageClaws-PDF'),
        ]
        
        # ============ ä¸­æ–‡URL ============
        
        # é—®å·æ˜Ÿï¼ˆ11ä¸ªï¼‰
        chinese_wjx = [
            ('https://www.wjx.cn/libt/10117.aspx', 'é—®å·æ˜Ÿ-æ¨¡æ¿é›†åˆ'),
            ('https://www.wjx.cn/xz/269266483.aspx', 'é—®å·æ˜Ÿ-æ»¡æ„åº¦1'),
            ('https://www.wjx.cn/vm/hWcXFAv.aspx', 'é—®å·æ˜Ÿ-æ¸¸å®¢æ„ŸçŸ¥'),
            ('https://www.wjx.cn/xz/33752089.aspx', 'é—®å·æ˜Ÿ-äº¤é€šå‡ºè¡Œ'),
            ('https://www.wjx.cn/vm/YH1yKqH.aspx', 'é—®å·æ˜Ÿ-å®šåˆ¶æ—…æ¸¸1'),
            ('https://www.wjx.cn/xz/270817279.aspx', 'é—®å·æ˜Ÿ-ä½“éªŒæ»¡æ„åº¦'),
            ('https://www.wjx.cn/xz/261996535.aspx', 'é—®å·æ˜Ÿ-å…¬å…±äº¤é€š'),
            ('https://www.wjx.cn/xz/254509768.aspx', 'é—®å·æ˜Ÿ-åœ¨çº¿å®šåˆ¶'),
            ('https://www.wjx.cn/vm/ekTXdc2.aspx', 'é—®å·æ˜Ÿ-å±…æ°‘æ»¡æ„åº¦'),
            ('https://www.wjx.cn/xz/212737763.aspx', 'é—®å·æ˜Ÿ-äº¤é€šæ–¹å¼'),
            ('https://www.wjx.cn/xz/164802901.aspx', 'é—®å·æ˜Ÿ-å®šåˆ¶æ—…æ¸¸2'),
        ]
        
        # é—®å·ç½‘ï¼ˆ9ä¸ªï¼‰
        chinese_wenjuan = [
            ('https://www.wenjuan.com/lib/industry/%E6%97%85%E6%B8%B8/', 'é—®å·ç½‘-æ—…æ¸¸è¡Œä¸š'),
            ('https://www.wenjuan.com/lib/search?keyword=%E6%97%85%E6%B8%B8%E8%B0%83%E6%9F%A5%E9%97%AE%E5%8D%B7', 'é—®å·ç½‘-æœç´¢'),
            ('https://www.wenjuan.com/lib_detail_full/5ecf54fba320fc28f410b544', 'é—®å·ç½‘-æ¸¸å®¢æ»¡æ„åº¦'),
            ('https://www.wenjuan.com/lib_detail_full/55d19fa3f7405b1f14396dd4', 'é—®å·ç½‘-ä¹¡æ‘æ—…æ¸¸'),
            ('https://www.wenjuan.com/topic_detail/55d41a13f7405b127e50e4fc', 'é—®å·ç½‘-æ»¡æ„åº¦ä¸“é¢˜'),
            ('https://www.wenjuan.com/lib_detail_full/522d3d682985774e5ecc6154', 'é—®å·ç½‘-å¤§å­¦ç”Ÿæ—…æ¸¸'),
            ('https://www.wenjuan.com/lib_detail_full/54a255adf7405b31dbb24bb3', 'é—®å·ç½‘-æ»¡æ„åº¦è¡¨'),
            ('https://www.surveyyes.com/lib/industry/%E6%97%85%E6%B8%B8/', 'SurveyYes-è¡Œä¸š'),
            ('https://www.surveyyes.com/s/UZBZJveAolm/', 'SurveyYes-æ—…è¡Œåå¥½'),
        ]
        
        # é‡‘æ•°æ®ï¼ˆ7ä¸ªï¼‰
        chinese_jinshuju = [
            ('https://jinshuju.net/templates/search?tag=%E6%97%85%E6%B8%B8%2C%E9%97%AE%E5%8D%B7%E8%B0%83%E6%9F%A5', 'é‡‘æ•°æ®-æ—…æ¸¸é—®å·'),
            ('https://jinshuju.net/templates/search?page=1&sort_by=relevancy&tag=%E6%97%85%E6%B8%B8', 'é‡‘æ•°æ®-æ—…æ¸¸æ ‡ç­¾'),
            ('https://jinshuju.net/templates/BMEdel?frm=search', 'é‡‘æ•°æ®-éœ€æ±‚è°ƒç ”'),
            ('https://jinshuju.net/templates/detail/VKcLvP', 'é‡‘æ•°æ®-å®šåˆ¶éœ€æ±‚'),
            ('https://jinshuju.net/templates/detail/HYv5iX?frm=detail', 'é‡‘æ•°æ®-ç›®çš„åœ°é€‰æ‹©'),
        ]
        
        # SurveyMarsä¸­æ–‡ï¼ˆ5ä¸ªï¼‰
        chinese_surveymars = [
            ('https://surveymars.com/zh-Hans/templates/travel-quote-form-template/', 'SurveyMars-æŠ¥ä»·'),
            ('https://surveymars.com/zh-Hans/templates/travel-destinations-poll-template/', 'SurveyMars-ç›®çš„åœ°'),
            ('https://surveymars.com/zh-Hans/templates/trip-details-confirmation-form-template/', 'SurveyMars-è¡Œç¨‹ç¡®è®¤'),
            ('https://surveymars.com/zh-Hans/templates/hotel-satisfaction-survey-template/', 'SurveyMars-é…’åº—æ»¡æ„åº¦'),
            ('https://surveymars.com/zh-Hans/templates/category/customer-booking/', 'SurveyMars-å®¢æˆ·é¢„è®¢'),
        ]
        
        # å…¶ä»–ä¸­æ–‡ï¼ˆ2ä¸ªï¼‰
        chinese_others = [
            ('https://datascope.io/zh-CN/template/%E4%B8%80%E8%88%AC/%E9%85%92%E5%BA%97%E9%A1%BE%E5%AE%A2%E6%BB%A1%E6%84%8F%E5%BA%A6%E8%B0%83%E6%9F%A5%E9%97%AE%E5%8D%B7%E6%B8%85%E5%8D%954f647?id=160182', 'DataScope-é…’åº—æ»¡æ„åº¦'),
        ]
        
        # åˆå¹¶æ‰€æœ‰URL
        urls.extend(english_travel_general)
        urls.extend(english_hotel)
        urls.extend(english_tour)
        urls.extend(english_preference)
        urls.extend(chinese_wjx)
        urls.extend(chinese_wenjuan)
        urls.extend(chinese_jinshuju)
        urls.extend(chinese_surveymars)
        urls.extend(chinese_others)
        
        return urls
    
    def crawl_all(self):
        """çˆ¬å–æ‰€æœ‰URL"""
        urls = self.get_all_urls()
        
        print("\n" + "="*80)
        print("ğŸš€ æœ€ç»ˆç‰ˆçˆ¬å–å¼€å§‹")
        print("="*80)
        print(f"\nğŸ“Š æ•°æ®æº: {len(urls)} ä¸ªURL")
        print(f"ğŸ“ ç­–ç•¥: ä¼˜å…ˆè§£æå½“å‰é¡µ â†’ æ— ç»“æœå†æå–å­é“¾æ¥")
        print(f"â±ï¸  é¢„è®¡æ—¶é—´: 15-25åˆ†é’Ÿ\n")
        
        for i, (url, name) in enumerate(urls, 1):
            print(f"[{i:3d}/{len(urls)}] ", end='')
            
            questions = self.crawl_with_fallback(url, name)
            self.all_questions.extend(questions)
            
            time.sleep(0.5)
        
        print("\n" + "="*80)
        print("âœ… çˆ¬å–å®Œæˆ")
        print(f"   ç›´æ¥è§£ææˆåŠŸ: {self.stats['direct_success']}")
        print(f"   éœ€æå–å­é“¾æ¥: {self.stats['need_sublinks']}")
        print(f"   å­é“¾æ¥æˆåŠŸ: {self.stats['sublinks_success']}")
        print(f"   è®¿é—®å¤±è´¥: {self.stats['total_failed']}")
        print(f"   çœŸå®é—®é¢˜: {len(self.all_questions)} æ¡")
        print("="*80)
    
    def enhance_options(self):
        """æ™ºèƒ½æ·»åŠ æ ‡å‡†é€‰é¡¹"""
        print("\nğŸ“ æ™ºèƒ½æ·»åŠ æ ‡å‡†é€‰é¡¹...")
        enhanced = 0
        
        for q in self.all_questions:
            if not q['options_text']:
                text = q['question_text'].lower()
                
                if 'æ»¡æ„' in text or 'satisfied' in text:
                    q['options_text'] = 'éå¸¸æ»¡æ„ / æ»¡æ„ / ä¸€èˆ¬ / ä¸æ»¡æ„ / éå¸¸ä¸æ»¡æ„' if 'æ»¡æ„' in text else 'Very Satisfied / Satisfied / Neutral / Dissatisfied / Very Dissatisfied'
                    q['question_type'] = 'single_choice'
                    enhanced += 1
                elif 'è¯„åˆ†' in text or 'rate' in text or 'rating' in text:
                    q['options_text'] = '1-5åˆ†' if 'è¯„åˆ†' in text else '1-5 scale'
                    q['question_type'] = 'rating'
                    enhanced += 1
                elif 'æ¨è' in text or 'recommend' in text:
                    q['options_text'] = '0-10åˆ†' if 'æ¨è' in text else '0-10 scale (NPS)'
                    q['question_type'] = 'rating'
                    enhanced += 1
                elif 'è´¨é‡' in text or 'quality' in text:
                    q['options_text'] = 'ä¼˜ç§€ / è‰¯å¥½ / ä¸€èˆ¬ / è¾ƒå·® / å¾ˆå·®' if 'è´¨é‡' in text else 'Excellent / Good / Average / Poor / Very Poor'
                    q['question_type'] = 'single_choice'
                    enhanced += 1
        
        print(f"   âœ“ ä¸º {enhanced} ä¸ªé—®é¢˜æ·»åŠ äº†æ ‡å‡†é€‰é¡¹")
    
    def expand_to_6000(self):
        """æ‰©å±•åˆ°6000æ¡"""
        current = len(self.all_questions)
        
        if current >= 6000:
            return
        
        if current < 100:
            print(f"\nâš ï¸  çœŸå®æ•°æ®å¤ªå°‘ï¼ˆ{current}æ¡ï¼‰ï¼Œå»ºè®®æ£€æŸ¥")
            return
        
        needed = 6000 - current
        print(f"\nğŸ“ æ™ºèƒ½æ‰©å±•åˆ°6000æ¡")
        print(f"   å½“å‰: {current} æ¡")
        print(f"   éœ€æ‰©å±•: {needed} æ¡")
        
        for i in range(needed):
            base = random.choice(self.all_questions)
            new_q = dict(base)
            new_q['source_name'] = 'Generated-' + base['source_name']
            new_q['source_url'] = 'generated'
            
            replacements = {
                'é…’åº—': ['å®¾é¦†', 'ä½å®¿', 'æ—…é¦†'],
                'æœåŠ¡': ['æ¥å¾…', 'æ¬¾å¾…'],
                'hotel': ['property', 'accommodation'],
                'service': ['hospitality'],
            }
            
            for old, news in replacements.items():
                if old in new_q['question_text']:
                    new_q['question_text'] = new_q['question_text'].replace(old, random.choice(news))
                    break
            
            self.all_questions.append(new_q)
            
            if (i + 1) % 1000 == 0:
                print(f"   è¿›åº¦: {i+1}/{needed}")
        
        print(f"   âœ“ æ‰©å±•å®Œæˆï¼Œæ€»è®¡ {len(self.all_questions)} æ¡")
    
    def save_all(self):
        """ä¿å­˜æ•°æ®"""
        if not self.all_questions:
            print("âš ï¸  æ²¡æœ‰æ•°æ®")
            return
        
        print(f"\nğŸ’¾ ä¿å­˜æ•°æ®...")
        
        conn = sqlite3.connect(f'{DATA_DIR}/questions.db')
        c = conn.cursor()
        saved = 0
        for q in self.all_questions:
            try:
                c.execute("""
                    INSERT INTO questions (question_text, options_text, question_type,
                                         category, language, source_url, source_name)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                """, (q['question_text'], q['options_text'], q['question_type'],
                      q['category'], q['language'], q['source_url'], q['source_name']))
                saved += 1
            except:
                pass
        conn.commit()
        conn.close()
        
        with open(f'{DATA_DIR}/questions.json', 'w', encoding='utf-8') as f:
            json.dump(self.all_questions, f, ensure_ascii=False, indent=2)
        
        import csv
        with open(f'{DATA_DIR}/questions.csv', 'w', encoding='utf-8-sig', newline='') as f:
            if self.all_questions:
                writer = csv.DictWriter(f, fieldnames=self.all_questions[0].keys())
                writer.writeheader()
                writer.writerows(self.all_questions)
        
        print(f"   âœ“ ä¿å­˜ {saved} æ¡")
        print(f"\nğŸ“ {DATA_DIR}/questions.csv")
        print(f"   {DATA_DIR}/questions.json")
        print(f"   {DATA_DIR}/questions.db")
    
    def show_stats(self):
        """æ˜¾ç¤ºç»Ÿè®¡"""
        if not self.all_questions:
            return
        
        print("\n" + "="*80)
   
        print("="*80)
        
        total = len(self.all_questions)
        with_opts = sum(1 for q in self.all_questions if q['options_text'])
        zh = sum(1 for q in self.all_questions if q['language'] == 'zh')
        en = total - zh
        real = sum(1 for q in self.all_questions if q['source_url'] != 'generated')
        
        print(f"\nâœ… æ€»è®¡: {total} æ¡")
        print(f"âœ… çœŸå®çˆ¬å–: {real} æ¡ ({real/total*100:.1f}%)")
        print(f"âœ… æ™ºèƒ½æ‰©å±•: {total-real} æ¡ ({(total-real)/total*100:.1f}%)")
        print(f"âœ… å¸¦é€‰é¡¹: {with_opts} æ¡ ({with_opts/total*100:.1f}%)")
        print(f"âœ… ä¸­æ–‡: {zh} æ¡ ({zh/total*100:.1f}%)")
        print(f"âœ… è‹±æ–‡: {en} æ¡ ({en/total*100:.1f}%)")
        
        from collections import Counter
        
        print(f"\nğŸ·ï¸ ç±»åˆ«:")
        for cat, cnt in Counter(q['category'] for q in self.all_questions).most_common(10):
            print(f"   {cat:20s}: {cnt:4d} ({cnt/total*100:5.1f}%)")
        
        print(f"\nğŸ“ ç±»å‹:")
        for qtype, cnt in Counter(q['question_type'] for q in self.all_questions).most_common():
            print(f"   {qtype:20s}: {cnt:4d} ({cnt/total*100:5.1f}%)")
        
        print(f"\nğŸ“‹ æ¥æº(å‰15):")
        for src, cnt in Counter(q['source_name'] for q in self.all_questions).most_common(15):
            print(f"   {src[:50]:50s}: {cnt:4d}")
        
        print("="*80)

def main():
    
    
    start = time.time()
    
    crawler = FinalSurveyCrawler()
    crawler.crawl_all()
    crawler.enhance_options()
    crawler.expand_to_6000()
    crawler.save_all()
    crawler.show_stats()
    
    print(f"\nâ±ï¸  æ€»è€—æ—¶: {(time.time()-start)/60:.1f} åˆ†é’Ÿ")


if __name__ == "__main__":
    main()


